dashboards:
  AWS-WAF-LOGS-DASHBOARD-FOR-EVENT-ANALYSIS-V1:
    dependsOn:
      datasets:
      - waf_logs_antiddos_least_fields_v2
    name: AWS-WAF-Logs-Dashboard-For-Event-Analysis-V1
    dashboardId: aws-waf-logs-dashboard-for-event-analysis-v1
    templateId: aws-waf-logs-dashboard-for-event-analysis-v1
    sourceAccountId: '698991684551'
    region: us-east-1
datasets:
  waf_logs_antiddos_least_fields_v2:
    data:
      DataSetId: 612def5a-b103-4e4d-8c04-a027e6fbe124
      Name: waf_logs_antiddos_least_fields_v2
      PhysicalTableMap:
        1201930c-cc9b-491d-8df9-b5be07a11b3b:
          RelationalTable:
            DataSourceArn: ${athena_datasource_arn}
            Catalog: AwsDataCatalog
            Schema: ${athena_database_name}
            Name: waf_logs_antiddos_view
            InputColumns:
            - Name: timestamp
              Type: INTEGER
            - Name: formatversion
              Type: INTEGER
            - Name: webaclid
              Type: STRING
            - Name: terminatingruleid
              Type: STRING
            - Name: terminatingruletype
              Type: STRING
            - Name: action
              Type: STRING
            - Name: ja3fingerprint
              Type: STRING
            - Name: httpsourcename
              Type: STRING
            - Name: httpsourceid
              Type: STRING
            - Name: clientip
              Type: STRING
            - Name: country
              Type: STRING
            - Name: httpmethod
              Type: STRING
            - Name: uri
              Type: STRING
            - Name: http_args
              Type: STRING
            - Name: http_version
              Type: STRING
            - Name: request_id
              Type: STRING
            - Name: hearder_value
              Type: STRING
            - Name: header_name
              Type: STRING
            - Name: account_id
              Type: STRING
            - Name: year
              Type: STRING
            - Name: month
              Type: STRING
            - Name: day
              Type: STRING
            - Name: protected_resource_type
              Type: STRING
            - Name: hour
              Type: STRING
            - Name: minute
              Type: STRING
      LogicalTableMap:
        a286b2f7-8acf-4e80-8034-93bedf5e8aa7:
          Alias: waf_logs_antiddos_least_fields_v2
          DataTransforms:
          - CastColumnTypeOperation:
              ColumnName: timestamp
              NewColumnType: DATETIME
          - TagColumnOperation:
              ColumnName: country
              Tags:
              - ColumnGeographicRole: COUNTRY
          - ProjectOperation:
              ProjectedColumns:
              - timestamp
              - formatversion
              - webaclid
              - terminatingruleid
              - terminatingruletype
              - action
              - ja3fingerprint
              - httpsourcename
              - httpsourceid
              - clientip
              - country
              - httpmethod
              - uri
              - http_args
              - http_version
              - request_id
              - hearder_value
              - header_name
              - account_id
              - year
              - month
              - day
              - protected_resource_type
              - hour
              - minute
          Source:
            PhysicalTableId: 1201930c-cc9b-491d-8df9-b5be07a11b3b
      ImportMode: DIRECT_QUERY
    dependsOn:
      views:
      - waf_logs_antiddos_view
views:
  waf_logs_antiddos_least_fields_v2:
    data: |-
      CREATE OR REPLACE VIEW "waf_logs_antiddos_view".waf_logs_antiddos_view AS
      SELECT
        "timestamp"
      , formatversion
      , webaclid
      , terminatingruleid
      , terminatingruletype
      , action
      , ja3fingerprint
      , httpsourcename
      , httpsourceid
      , HTTPREQUEST.clientip clientip
      , HTTPREQUEST.country country
      , HTTPREQUEST.httpMethod httpMethod
      , httprequest.uri uri
      , httprequest.args http_args
      , httprequest.httpversion http_version
      , httprequest.requestid request_id
      , header.value "hearder_value"
      , header.name "header_name"
      , partition_0 "Account_ID"
      , partition_4 "Year"
      , partition_5 "month"
      , partition_6 "day"
      , partition_2 "protected_resource_type"
      , partition_7 "hour"
      , partition_8 "minute"
      FROM
        "AwsDataCatalog"."waflogsdb"."awslogs"
      , UNNEST(httprequest.headers) t (header)
      WHERE (CAST("concat"("partition_4", '-', "partition_5", '-01') AS date) >= ("date_trunc"('month', current_date) - INTERVAL  '7' MONTH))
